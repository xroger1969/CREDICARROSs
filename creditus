<!DOCTYPE html>
<html lang="pt-PT">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simulador Crédito Automóvel (Usados 60–120m)</title>
<style>
  :root{--bg:#0b1020;--card:#121a34;--soft:#1b2548;--text:#eaf1ff;--muted:#9fb2dd;--accent:#5ea0ff;--border:#223060}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
  .wrap{max-width:1200px;margin:0 auto;padding:20px}
  h1{margin:0 0 8px;font-size:clamp(20px,3vw,28px)}
  .lead{color:var(--muted);margin:0 0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
  .grid{display:grid;gap:12px}
  .g-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:980px){.g-3{grid-template-columns:1fr}}
  label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
  input,select{width:100%;padding:10px 12px;background:#0f1733;border:1px solid #233469;color:var(--text);border-radius:10px}
  input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px #5ea0ff33;outline:none}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid #2b3a72;background:#0e1631;color:#fff;cursor:pointer}
  .btn:hover{border-color:var(--accent)}
  .btn.primary{background:linear-gradient(180deg,#2a64ff,#1d50d6);border-color:#2a64ff}
  .btn.danger{border-color:#6b2b2b;background:#2a0e0e}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#11306a;color:#cfe0ff;font-size:12px;border:1px solid #2b4a8b}
  .kpi{background:var(--soft);border:1px solid #2b3a72;padding:12px;border-radius:14px}
  .kpi small{display:block;color:var(--muted);font-size:12px}
  .kpi b{font-size:18px}
  .note{color:#b9c9ee;font-size:12px}
  .split{display:grid;grid-template-columns:2fr 1fr;gap:16px}
  @media (max-width:1100px){.split{grid-template-columns:1fr}}
  .scroll{max-height:420px;overflow:auto;border:1px solid #2b3a72;border-radius:12px}
  table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px}
  thead th{position:sticky;top:0;background:#131d3e;color:#cfe0ff;text-align:left;padding:10px;border-bottom:1px solid #2b3a72}
  tbody td{padding:10px;border-bottom:1px dashed #2a396f}
</style>
</head>
<body>
<div class="wrap">
  <h1>Simulador Crédito Automóvel (Usados) – 60 a 120 meses</h1>
  <p class="lead">TAN <b>9,5%</b> (editável), despesas admin. €350, comissão de abertura (fixa ou %), Imposto do Selo: <b>0,6%</b> capital + <b>4%</b> juros/comissões. Com e sem entrada.</p>

  <div class="split">
    <div class="card">
      <div class="grid g-3">
        <div>
          <label>Preço veículo (€) <span class="pill">opcional</span></label>
          <input type="number" id="preco" min="0" step="100" placeholder="ex.: 14500" />
        </div>
        <div>
          <label>Entrada (€) <span class="pill">opcional</span></label>
          <input type="number" id="entrada" min="0" step="100" placeholder="ex.: 2000" />
        </div>
        <div>
          <label>Montante a financiar (€)</label>
          <input type="number" id="montante" min="0" max="70000" step="100" value="10000" />
        </div>

        <div>
          <label>Prazo (meses)</label>
          <select id="prazo">
            <option>60</option><option>72</option><option selected>84</option>
            <option>96</option><option>108</option><option>120</option>
          </select>
        </div>
        <div>
          <label>TAN anual (%)</label>
          <input type="number" id="tan" min="0" step="0.01" value="9.5" />
        </div>
        <div>
          <label>Despesas administrativas (€)</label>
          <input type="number" id="despAdmin" min="0" step="1" value="350" />
        </div>

        <div>
          <label>Comissão de abertura – tipo</label>
          <select id="tipoCom">
            <option value="fixa" selected>Fixa (€)</option>
            <option value="percent">Percentual (% do montante)</option>
          </select>
        </div>
        <div>
          <label>Comissão de abertura (valor)</label>
          <input type="number" id="valorCom" min="0" step="0.01" value="300" />
        </div>
        <div>
          <label>Financiar comissões/despesas?</label>
          <select id="financiar">
            <option value="nao" selected>Não (pagas no início)</option>
            <option value="sim">Sim (somadas ao capital)</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn primary" onclick="calc()">Calcular</button>
        <button class="btn" onclick="csv()">Exportar CSV</button>
        <button class="btn danger" onclick="limpar()">Limpar</button>
        <span class="note">Dica: se preencher <b>Preço</b> e <b>Entrada</b>, calculo o <b>Montante</b> automaticamente.</span>
      </div>
      <div id="aviso" class="note" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <div class="grid g-3">
        <div class="kpi"><small>Prestação</small><b id="kPrestacao">—</b></div>
        <div class="kpi"><small>TAEG (anual)</small><b id="kTAEG">—</b></div>
        <div class="kpi"><small>MTIC (total a pagar)</small><b id="kMTIC">—</b></div>
        <div class="kpi"><small>Juros totais</small><b id="kJuros">—</b></div>
        <div class="kpi"><small>Imposto do Selo (total)</small><b id="kIS">—</b></div>
        <div class="kpi"><small>Upfront pago no início</small><b id="kUpfront">—</b></div>
      </div>
      <p class="note" style="margin-top:10px">
        IS: <b>0,6%</b> sobre capital (60–120m) + <b>4%</b> sobre juros e comissões. TAEG por IRR (rendimento interno).
      </p>
    </div>
  </div>

  <div class="grid g-3" style="margin-top:16px">
    <div class="card"><h3 style="margin:0 0 8px">Custos Upfront</h3><div id="upfrontList" class="note">—</div></div>
    <div class="card"><h3 style="margin:0 0 8px">Custos Mensais</h3><div id="mensaisList" class="note">—</div></div>
    <div class="card"><h3 style="margin:0 0 8px">Resumo</h3><div id="resumoList" class="note">—</div></div>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="row" style="justify-content:space-between; align-items:flex-end">
      <h3 style="margin:0">Tabela de Amortização</h3>
      <span class="note">Inclui IS de 4% sobre o juro mensal.</span>
    </div>
    <div class="scroll" style="margin-top:10px">
      <table id="tabela">
        <thead>
          <tr>
            <th>Mês</th><th>Prestação</th><th>Juro</th><th>IS s/ Juro (4%)</th>
            <th>Amortização</th><th>Saldo</th>
          </tr>
        </thead>
        <tbody><tr><td colspan="6" style="text-align:center; padding:16px">—</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<script>
// Format a number to Euro currency (Portuguese locale)
const formatEUR = n => (isFinite(n) ? n : 0).toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' });
const pct = x => (isFinite(x) ? (100 * x).toFixed(2) + ' %' : '—');

function pmt(rate,nper,pv,fv=0,type=0){
  if(rate===0) return -(pv+fv)/nper;
  const r=rate, v=Math.pow(1+r,nper);
  return -(r*(fv + v*pv))/((-1+v)*(1+r*type));
}
function irr(cashflows, guess=0.01){
  const npv=r=>cashflows.reduce((s,c,t)=>s + c/Math.pow(1+r,t),0);
  const dnpv=r=>cashflows.reduce((s,c,t)=> s + (-t*c)/Math.pow(1+r,t+1),0);
  let r=guess, tol=1e-8;
  for(let k=0;k<80;k++){
    const f=npv(r), df=dnpv(r); if(Math.abs(df)<1e-12) break;
    const r1=r - f/df; if(!isFinite(r1)) break; if(Math.abs(r1-r)<tol) return r1; r=r1;
  }
  let r0=-0.9, r1=0.9;
  for(let k=0;k<120;k++){
    const f0=npv(r0), f1=npv(r1), den=f1-f0; if(Math.abs(den)<1e-14) break;
    const r2=r1 - f1*(r1-r0)/den; if(Math.abs(r2-r1)<tol) return r2; r0=r1; r1=r2;
  }
  return NaN;
}

function el(id){ return document.getElementById(id); }
function val(id){ const e=el(id); return e? parseFloat(e.value.replace(',', '.')) : NaN; }
function set(id,v){ const e=el(id); if(e) e.value=v; }
function setText(id,t){ const e=el(id); if(e) e.textContent=t; }

function calc(){
  // Montante: se houver preço+entrada, calculo; senão uso o campo montante
  const preco = isFinite(val('preco'))? val('preco'):0;
  const entrada = isFinite(val('entrada'))? val('entrada'):0;
  let montante = isFinite(val('montante'))? val('montante'):0;
  if(preco>0){ montante = Math.max(0, preco - (entrada||0)); set('montante', Math.round(montante)); }

  const prazo = parseInt(el('prazo').value,10);
  const tan = (isFinite(val('tan'))? val('tan'):0)/100;
  const despAdmin = isFinite(val('despAdmin'))? val('despAdmin'):0;
  const tipoCom = el('tipoCom').value;
  const valorCom = isFinite(val('valorCom'))? val('valorCom'):0;
  const financiar = el('financiar').value;

  const comAbertura = (tipoCom==='percent') ? montante*(valorCom/100) : valorCom;

  // IS: 0,6% capital (prazo 60–120) + 4% sobre comissões e juros
  const IS_capital = 0.006 * montante;
  const IS_comissoes = 0.04 * (comAbertura + despAdmin);

  const upfrontBruto = comAbertura + despAdmin + IS_comissoes + IS_capital;

  let capitalBase = montante;
  let upfrontPagoNoInicio = upfrontBruto;
  if(financiar==='sim'){
    capitalBase += upfrontBruto; // financiar custos
    upfrontPagoNoInicio = 0;
  }

  const i = tan/12;
  const prest = pmt(i, prazo, -capitalBase);

  let saldo=capitalBase, jurosTot=0, isJurosTot=0;
  const rows=[];
  for(let m=1;m<=prazo;m++){
    const juros = saldo * i;
    const amort = prest - juros;
    saldo = Math.max(0, saldo - amort);
    const isJuro = 0.04 * juros;  // 4% IS sobre juro mensal
    jurosTot += juros; isJurosTot += isJuro;
    rows.push({m, prest, juros, isJuro, amort, saldo});
  }

  const somaMensal = rows.reduce((s,r)=> s + (r.prest + r.isJuro), 0);
  const MTIC = upfrontPagoNoInicio + somaMensal;

  const cfs = [];
  cfs.push(montante - upfrontPagoNoInicio);
  rows.forEach(r=> cfs.push( -(r.prest + r.isJuro) ));
  const irrMensal = irr(cfs, 0.01);
  const taeg = isFinite(irrMensal) ? (Math.pow(1+irrMensal,12)-1) : NaN;

  setText('kPrestacao', formatEUR(prest));
  setText('kTAEG', isFinite(taeg) ? pct(taeg) : '—');
  setText('kMTIC', formatEUR(MTIC));
  setText('kJuros', formatEUR(jurosTot));
  setText('kIS', formatEUR(IS_capital + IS_comissoes + isJurosTot));
  setText('kUpfront', formatEUR(upfrontPagoNoInicio));

  el('upfrontList').innerHTML = `
    • Comissão abertura: <b>${formatEUR(comAbertura)}</b><br/>
    • Despesas administrativas: <b>${formatEUR(despAdmin)}</b><br/>
    • IS comissões (4%): <b>${formatEUR(IS_comissoes)}</b><br/>
    • IS capital (0,6%): <b>${formatEUR(IS_capital)}</b><br/>
    • Financiar upfront? <b>${financiar === 'sim' ? 'Sim' : 'Não'}</b>
  `.trim();

  el('mensaisList').innerHTML = `
    • Prestação (constante): <b>${formatEUR(prest)}</b><br/>
    • IS sobre juros (4%): <b>${formatEUR(isJurosTot)}</b> (total)
  `.trim();

  el('resumoList').innerHTML = `
    • Juros totais: <b>${formatEUR(jurosTot)}</b><br/>
    • Imposto do Selo total: <b>${formatEUR(IS_capital + IS_comissoes + isJurosTot)}</b><br/>
    • MTIC: <b>${formatEUR(MTIC)}</b>
  `.trim();

  const tbody = document.querySelector('#tabela tbody');
  tbody.innerHTML = rows.map(r => `
    <tr>
      <td>${r.m}</td>
      <td>${formatEUR(r.prest)}</td>
      <td>${formatEUR(r.juros)}</td>
      <td>${formatEUR(r.isJuro)}</td>
      <td>${formatEUR(r.amort)}</td>
      <td>${formatEUR(r.saldo)}</td>
    </tr>
  `).join('');

  const aviso=[];
  if(montante>70000) aviso.push('Montante máximo recomendado: 70.000 €');
  if(prazo<60 || prazo>120) aviso.push('Prazos suportados: 60–120 meses');
  el('aviso').textContent = aviso.join(' • ');
}

// export CSV
function csv(){
  const table=document.getElementById('tabela'); let csv='';
  table.querySelectorAll('tr').forEach(row=>{
    const cols=[...row.children].map(td=>`"${td.innerText}"`); csv += cols.join(',')+'\n';
  });
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}), url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='amortizacao.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

// limpar
function limpar(){
  ['preco','entrada','montante','tan','despAdmin','valorCom'].forEach(id=>set(id,''));
  set('montante','10000'); set('prazo','84'); set('tan','9.5'); set('despAdmin','350'); set('tipoCom','fixa'); set('valorCom','300'); set('financiar','nao');
  document.querySelector('#tabela tbody').innerHTML='<tr><td colspan="6" style="text-align:center; padding:16px">—</td></tr>';
  ['kPrestacao','kTAEG','kMTIC','kJuros','kIS','kUpfront'].forEach(id=>setText(id,'—'));
  el('upfrontList').textContent='—'; el('mensaisList').textContent='—'; el('resumoList').textContent='—'; el('aviso').textContent='';
}

// recálculo automático ao editar campos
['preco','entrada','montante','prazo','tan','despAdmin','tipoCom','valorCom','financiar'].forEach(id=>{
  const e=el(id); if(e){ e.addEventListener('change', ()=>calc()); e.addEventListener('keyup', ()=>calc()); }
});

calc();
</script>
</body>
</html>
